<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sandra S7 ‚Ä¢ Reborn</title>
  <meta name="description" content="Sandra IA S7 ‚Äî chat + voz listo para producci√≥n con Netlify Functions" />
  <style>
    :root { --bg:#0b1116; --fg:#e6eef3; --muted:#93a4b2; --primary:#00c2a8; --border:#1a2a36; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif}
    a{color:var(--primary);text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:28px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .logo{font-weight:700;letter-spacing:.4px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;background:#0f151b;border:1px solid var(--border);color:var(--fg)}
    .btn{background:var(--primary);color:#041217;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#0f151b;color:var(--fg);border:1px solid var(--border)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .card{border:1px solid var(--border);border-radius:14px;background:#0f151b;padding:16px}
    #chat-log{height:240px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:12px;background:#0b1116}
    #chat-log .msg{margin:6px 0}
    #chat-log .me{color:#9ad4ff}
    #chat-log .ai{color:#aef0df}
    input[type="text"]{background:#0b1116;border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--fg);flex:1}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    iframe{width:100%;height:320px;border:1px solid var(--border);border-radius:12px;background:#000}
    footer{opacity:.7;margin-top:28px;font-size:12px}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">Sandra S7 ‚Ä¢ Reborn</div>
      <a href="#sandra" class="chip">Habla con Sandra</a>
    </header>

    <main class="grid">
      <section id="sandra">
        <h2>Atenci√≥n con Sandra IA 7‚òÖ</h2>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin:12px 0">
          <button class="chip" onclick="SandraUI.show('text')">Texto</button>
          <button class="chip" onclick="SandraUI.show('voice')">Voz</button>
          <button class="chip" onclick="SandraUI.show('avatar')">Avatar</button>
        </div>

        <div id="panel-text" class="card">
          <div id="chat-log"></div>
          <div class="row" style="margin-top:10px">
            <input id="chat-input" placeholder="Escribe tu mensaje para Sandra..." />
            <button id="btnSend" class="btn">Enviar</button>
          </div>
        </div>

        <div id="panel-voice" class="card hidden">
          <p class="small" style="opacity:.8">Pulsa ‚ÄúMantener‚Äù para dictar y suelta para enviar. Usa auriculares si puedes.</p>
          <div class="row">
            <button class="btn" onmousedown="SandraAPI.startDictation()" onmouseup="SandraAPI.stopDictation()">üéôÔ∏è Mantener para dictar</button>
            <button class="btn secondary" onclick="SandraAPI.speak('Hola, soy Sandra. Sistema listo.')">Probar voz</button>
          </div>
          <div id="voice-status" class="small" style="margin-top:8px;opacity:.8"></div>
        </div>

        <div id="panel-avatar" class="card">
          <iframe id="avatar-frame" src="about:blank" title="Avatar Sandra" style="width:100%;height:400px;border:0;border-radius:8px;background:#000"></iframe>
          <div style="margin-top:10px">
            <button class="btn" onclick="loadAvatarEmbed()">Cargar Avatar</button>
            <button class="btn secondary" onclick="testAvatar()">Test Avatar</button>
          </div>
        </div>
      </section>
    </main>

    <footer>¬© 2025 Guests Valencia ¬∑ Sistema Sandra S7</footer>
  </div>

  <script src="/assets/js/config.js" type="text/javascript"></script>
  <script src="/assets/js/sandra.js" type="text/javascript"></script>
  <script src="/assets/js/wire-up.min.js" defer></script>
  <script src="/assets/js/wire-voice.min.js" defer></script>
  <script src="/assets/js/bargein.min.js" defer></script>

  <script>
    // Sistema TTS con ElevenLabs
    async function playSandraFromText(text) {
      if (!text || !text.trim()) return;

      // A√±adir mensaje al chat log
      const chatLog = document.getElementById('chat-log');
      if (chatLog) {
        const userMsg = document.createElement('div');
        userMsg.className = 'msg me';
        userMsg.textContent = `üßë ${text}`;
        chatLog.appendChild(userMsg);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      try {
        const r = await fetch('/.netlify/functions/tts', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ text })
        });

        if (!r.ok) {
          const msg = await r.text();
          console.error('TTS error:', msg);
          return;
        }

        const buf = await r.arrayBuffer();
        const blob = new Blob([buf], { type: 'audio/mpeg' });
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);

        // A√±adir respuesta al chat log
        if (chatLog) {
          const aiMsg = document.createElement('div');
          aiMsg.className = 'msg ai';
          aiMsg.textContent = 'ü§ñ Respondiendo...';
          chatLog.appendChild(aiMsg);
          chatLog.scrollTop = chatLog.scrollHeight;
        }

        audio.play();
      } catch (e) {
        console.error('Network error:', e);
      }
    }

    // Avatar functions
    async function loadAvatarEmbed() {
      try {
        const r = await fetch('/.netlify/functions/heygen-share', { method:'POST' });
        const j = await r.json().catch(() => ({}));
        const u = (j?.data?.url || j?.url || '').replace('/share/', '/embeds/');
        document.getElementById('avatar-frame').src = u || 'about:blank';
      } catch {
        document.getElementById('avatar-frame').src = 'https://placehold.co/400x300/000000/ffffff?text=Avatar+Sandra';
      }
    }

    function testAvatar() {
      playSandraFromText('Hola, soy Sandra. ¬øEn qu√© puedo ayudarte hoy?');
    }

    // Conectar bot√≥n Enviar del chat
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('chat-input');
      const btn = document.getElementById('btnSend');

      if (btn) {
        btn.addEventListener('click', () => {
          const value = (input && input.value) ? input.value.trim() : '';
          if (value) {
            playSandraFromText(value);
            if (input) input.value = '';
          }
        });
      }

      // Enter para enviar
      if (input) {
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            btn?.click();
          }
        });
      }

      // Cargar avatar autom√°ticamente
      loadAvatarEmbed();
    });

    // Puentes para sistema barge-in
    window.__registerStreamAbort = (controller) => window.SandraBargeIn?.armAbort(() => controller.abort());

    // Conectar dictado si existe
    if (window.sandraIA?.startDictation) SandraBargeIn.setDictation(() => sandraIA.startDictation());
    if (window.SandraAPI?.startVoice) SandraBargeIn.setDictation(() => SandraAPI.startVoice());
  </script>
</body>
</html>
