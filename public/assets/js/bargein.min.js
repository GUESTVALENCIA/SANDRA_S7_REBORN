(()=>{const L=console.log.bind(console,"[BARGE-IN]");let o=null,a=null,t=null,r=!1,n=!1,i={threshold:.06,winMs:50,needFrames:6,hangMs:400,onSpeech:()=>{},stopTTS:()=>{},startDictation:()=>{},abortStream:()=>{}};function s(e){try{const t=new(window.AudioContext||window.webkitAudioContext);const r=t.createMediaStreamSource(e),n=t.createAnalyser();n.fftSize=1024;const s=new Float32Array(n.fftSize);r.connect(n);let c=0,u=0,d=Date.now();(function f(){if(!o)return; n.getFloatTimeDomainData(s);let e=0;for(let t=0;t<s.length;t++){const r=s[t];e+=r*r}const l=Math.sqrt(e/s.length);l>i.threshold?(u++,c=0):(c++,u=Math.max(0,u-1));const h=u>=i.needFrames;const g=Date.now();if(h&&!r){r=!0;d=g;L("detected speech â‰¥ threshold");p()} if(r&&g-d>i.hangMs&&c>i.needFrames){r=!1;L("end speech");} t&&t.resume?.(); a=requestAnimationFrame(f)})()}catch(e){L("audio init error",e)}}function p(){try{i.stopTTS?.()}catch(e){}try{i.abortStream?.()}catch(e){}try{i.startDictation?.()}catch(e){} i.onSpeech?.()}function c(){if(n)return; n=!0; window.addEventListener("click",async function l(){window.removeEventListener("click",l,{capture:!0});try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});o=e; s(e);L("mic ready")}catch(e){L("mic denied",e)}},{capture:!0,once:!0})}const u={init(e={}){Object.assign(i,e);c();this.patch()},patch(){const e=(w,h)=>{try{const m=w[h];if(!m||m.__patched)return;w[h]=async function(...A){try{n||c();r=!0;const S=await m.apply(this,A);return u._armStopper(S),S}finally{}};w[h].__patched=!0}catch{}}; const d=(w,h)=>{try{const m=w[h];if(!m||m.__patched)return;w[h]=function(...A){try{const C=new AbortController;i.abortStream=()=>C.abort();A.push(C);return m.apply(this,A)}finally{}};w[h].__patched=!0}catch{}}; if(window.SandraAPI){e(window.SandraAPI,"playTTS");e(window.SandraAPI,"speak");e(window.SandraAPI,"tts"); if(window.SandraAPI.startVoice) i.startDictation=()=>window.SandraAPI.startVoice()} if(window.sandraIA){e(window.sandraIA,"speak");e(window.sandraIA,"tts"); if(window.sandraIA.startDictation) i.startDictation=()=>window.sandraIA.startDictation()} try{const _p=HTMLAudioElement.prototype.play;if(!_p.__patched){HTMLAudioElement.prototype.play=function(...A){try{n||c();r=!0;const el=this; i.stopTTS=()=>{try{el.pause(),el.currentTime=0}catch{}}; const P=_p.apply(this,A);return Promise.resolve(P).catch(()=>{}),P}finally{}};HTMLAudioElement.prototype.play.__patched=!0}}catch{}},_armStopper(S){try{if(!S)return; if(typeof S.stop==="function"){i.stopTTS=()=>{try{S.stop(0)}catch{}};return} if(S.nodeType===1&&S.tagName==="AUDIO"){i.stopTTS=()=>{try{S.pause(),S.currentTime=0}catch{}}}}catch{}},armAbort(fn){i.abortStream=fn},setDictation(fn){i.startDictation=fn},setThreshold(v){i.threshold=v},status(){return {haveMic:!!o,playing:r,threshold:i.threshold}}}; window.SandraBargeIn=u; document.addEventListener("DOMContentLoaded",()=>u.init());})();