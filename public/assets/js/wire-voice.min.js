(()=>{const e=t=>document.querySelector(t),o=document.getElementById("voice-status")||e("#panel-voice .small")||e("#panel-voice [data-status]")||e("#sandra [data-status]")||null,i=(e=>{const t=[...document.querySelectorAll("button")];return e("#voice-btn")||e("[data-voice]")||t.find((e=>/voz|grabar|hablar|🎙️|mic/i.test((e.textContent||e.ariaLabel||"").trim())))})(e),n=document.getElementById("chat-log");let a,r,s;function d(e){o&&(o.textContent=e),console.info("VOICE:",e)}function l(e,t="bot"){if(!n)return;const o=document.createElement("div");o.style.margin="6px 0",o.textContent=("yo"===t?"🧑 ":"🤖 ")+e,n.appendChild(o),n.scrollTop=n.scrollHeight}async function c(){try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});return e.getTracks().forEach((e=>e.stop())),!0}catch(e){return d("Permiso de micrófono denegado: "+(e?.message||e)),!1}}async function u(){if(window.SandraAPI?.startVoice)return d("Usando SandraAPI.startVoice()…"),void window.SandraAPI.startVoice();if(window.sandraIA?.startDictation)return d("Usando sandraIA.startDictation()…"),void window.sandraIA.startDictation();if(!await c())return;a=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,sampleRate:48e3}}),r=new MediaRecorder(a,{mimeType:"audio/webm"});let e=[];r.ondataavailable=t=>{t.data.size>0&&e.push(t.data),s&&1===s.readyState&&s.send(t.data)},r.onstart=()=>d("🎙️ Grabando… suelta para enviar"),r.onstop=async()=>{d("Procesando audio…");new Blob(e,{type:"audio/webm"});window.sandraIA?.speak&&window.sandraIA.speak("Procesando audio");d("STT cliente no disponible: integra WS /ws/stt o usa startDictation nativo.")};try{s=new WebSocket(("https:"===location.protocol?"wss":"ws")+"://"+location.host+"/ws/stt"),s.onopen=()=>{d("Conectado a WS STT");try{r.start(150)}catch(e){d("MediaRecorder error: "+(e?.message||e))}},s.onmessage=t=>{try{const o=JSON.parse(t.data);o?.text&&(f(o.text,"yo"),m(o.text))}catch(e){}},s.onerror=()=>d("WS error STT"),s.onclose=()=>d("WS cerrado")}catch(e){d("No fue posible conectar WS STT");try{r.start(150)}catch(e){d("MediaRecorder error: "+(e?.message||e))}}}function y(){if(window.SandraAPI?.stopVoice)return d("Parando SandraAPI…"),void window.SandraAPI.stopVoice();try{r&&"inactive"!==r.state&&r.stop()}catch(e){}a&&(a.getTracks().forEach((e=>e.stop())),a=null),s&&1===s.readyState&&s.close(),d("Micrófono detenido.")}function f(e,t){l(e,t)}async function m(e){try{if(window.SandraAPI?.sendText){const t=await window.SandraAPI.sendText(e);return void l(t?.reply||JSON.stringify(t)||"✓ Enviado")}let t=await fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e})});if(404===t.status||405===t.status&&(t=await fetch("/.netlify/functions/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e})})),!t.ok)throw new Error("HTTP "+t.status);const o=await t.json();l(o?.reply||JSON.stringify(o)||"✓ Enviado")}catch(t){l("Error voz→chat: "+(t?.message||t))}}function p(){if(i){const e=()=>u(),o=()=>y();i.addEventListener("mousedown",e),i.addEventListener("touchstart",e),window.addEventListener("mouseup",o),window.addEventListener("touchend",o),i.title=i.title||"Mantén pulsado para hablar"}d("wire-voice listo")}document.addEventListener("DOMContentLoaded",p),"complete"===document.readyState&&p(),window.__voiceCheck=async()=>{const e=await navigator.mediaDevices.enumerateDevices();return console.table(e.map((e=>({kind:e.kind,label:e.label})))),e}})();