# Deploy Instructions - GuestsValencia PWA

## üöÄ Deploy desde GitHub Limpio

### Pre-Deploy Checklist
- [ ] Todos los cambios commiteados
- [ ] Branch main actualizado
- [ ] Tests locales pasando
- [ ] Variables de entorno configuradas

### Deploy Autom√°tico (Recomendado)
```bash
# 1. Push a main triggerea deploy autom√°tico
git push origin main

# 2. Monitorear deploy en Netlify
# URL: https://app.netlify.com/sites/guestsvalencia/deploys

# 3. Ejecutar smoke tests post-deploy
./ops/smoke.sh https://guestsvalencia.es
```

### Deploy Manual (Solo emergencias)
```bash
# 1. Netlify CLI deploy
netlify deploy --prod --dir=.

# 2. Verificar deploy exitoso
netlify open:site

# 3. Smoke tests
./ops/smoke.sh
```

## üîß "Clear Cache and Deploy"

### Limpiar Cache CDN
```bash
# Opci√≥n 1: Netlify Dashboard
# Ir a Site settings ‚Üí Build & deploy ‚Üí Post processing
# Click "Clear cache and deploy site"

# Opci√≥n 2: CLI
netlify api clearCache --site-id=$NETLIFY_SITE_ID

# Opci√≥n 3: Trigger rebuild
curl -X POST -d '{}' "https://api.netlify.com/build_hooks/$BUILD_HOOK_ID"
```

### Cache Busting para Assets
```bash
# Verificar que assets tengan cache headers
curl -I https://guestsvalencia.es/assets/img/pwa-192.png | grep -i cache

# Expected: Cache-Control: public, max-age=31536000, immutable
```

## üåê DNS Configuration (Netlify DNS)

### Configuraci√≥n Actual
```
Domain: guestsvalencia.es
DNS Provider: Netlify DNS
Nameservers:
  - dns1.p02.nsone.net
  - dns2.p02.nsone.net
  - dns3.p02.nsone.net
  - dns4.p02.nsone.net
```

### Records DNS Requeridos
```
A @ 75.2.60.5 (Netlify Load Balancer)
AAAA @ 2600:1f18:3b4c:c500::40 (Netlify IPv6)
CNAME www guestsvalencia.es
TXT @ "v=spf1 include:_spf.google.com ~all"
```

### Verificar DNS Propagation
```bash
# Verificar A record
dig A guestsvalencia.es

# Verificar CNAME
dig CNAME www.guestsvalencia.es

# Test desde m√∫ltiples locations
# Usar: https://dnschecker.org/
```

## üîê Variables de Entorno Inyectadas

### Variables P√∫blicas (NEXT_PUBLIC_*)
```bash
# PWA Configuration
NEXT_PUBLIC_PWA_NAME="GuestsValencia"
NEXT_PUBLIC_PWA_SHORT_NAME="GV"
NEXT_PUBLIC_PWA_THEME_COLOR="#0b1020"

# API Endpoints (p√∫blicos)
NEXT_PUBLIC_API_BASE_URL="https://guestsvalencia.es/api"
NEXT_PUBLIC_SANDRA_AVATAR_ID="default"

# Analytics (p√∫blico)
NEXT_PUBLIC_GA_TRACKING_ID="G-XXXXXXXXXX"
```

### Variables Privadas (Backend)
```bash
# API Keys (NUNCA en frontend)
SANDRA_API_KEY="sandra_prod_sk_xxx"
ELEVENLABS_API_KEY="sk_prod_xxx"
HEYGEN_API_KEY="hg_prod_xxx"

# Webhooks
WHATSAPP_WEBHOOK_SECRET="wh_secret_xxx"
NETLIFY_WEBHOOK_SECRET="ntl_secret_xxx"
```

### Configurar Variables
```bash
# Producci√≥n
netlify env:set SANDRA_API_KEY "sandra_prod_sk_xxx" --site guestsvalencia
netlify env:set ELEVENLABS_API_KEY "sk_prod_xxx" --site guestsvalencia

# Preview/Staging
netlify env:set SANDRA_API_KEY "sandra_test_sk_xxx" --site preview-guestsvalencia
netlify env:set ELEVENLABS_API_KEY "sk_test_xxx" --site preview-guestsvalencia

# Verificar configuraci√≥n
netlify env:list --site guestsvalencia
```

## üìä Monitoreo Post-Deploy

### Health Checks Autom√°ticos
```bash
# Smoke test completo
./ops/smoke.sh https://guestsvalencia.es

# Monitor continuo (durante deploy)
watch -n 10 './ops/smoke.sh https://guestsvalencia.es'
```

### M√©tricas Clave
- **Time to First Byte:** < 200ms
- **Largest Contentful Paint:** < 2.5s
- **First Input Delay:** < 100ms
- **Cumulative Layout Shift:** < 0.1

### Alertas Configuradas
- 5xx errors > 1%
- Response time > 2s
- Uptime < 99.9%
- Failed deploys

## üö® Rollback si Smoke Tests Fallan

### Autom√°tico (configurado en netlify.toml)
```bash
# Si smoke tests fallan, rollback autom√°tico
if ! ./ops/smoke.sh; then
    echo "üö® Deploy failed, initiating rollback"
    # Ver ops/rollback.md para procedimiento completo
fi
```

### Manual
```bash
# 1. Ir a Netlify Dashboard
# https://app.netlify.com/sites/guestsvalencia/deploys

# 2. Encontrar √∫ltimo deploy estable (‚úÖ)
# 3. Click "..." ‚Üí "Publish deploy"
# 4. Confirmar rollback
# 5. Verify: ./ops/smoke.sh
```

## üìã Deploy Success Criteria

### DoD (Definition of Done)
- [ ] Deploy build exitoso (verde en Netlify)
- [ ] Todas las variables inyectadas correctamente
- [ ] Smoke tests pasan al 100%
- [ ] Headers de seguridad configurados
- [ ] PWA funcionando (manifest + SW)
- [ ] DNS resolving correctamente
- [ ] Cache policies activas
- [ ] No regresiones detectadas
- [ ] Rollback documentado y probado

### Performance Targets
- [ ] Lighthouse Score > 90
- [ ] Core Web Vitals verdes
- [ ] Mobile-first responsive
- [ ] Offline capability (PWA)

---
**√öltima actualizaci√≥n:** Auto-generated by DevOps Agent
**Responsable:** ClayTom Systems DevOps Team