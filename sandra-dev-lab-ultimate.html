<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sandra Dev Lab Ultimate ¬∑ Auto-Entrenamiento con Memoria</title>
    <meta name="description" content="Entorno de auto-entrenamiento para Sandra IA con memoria, feedback y burbujas Sonoma.">
    <link rel="icon" href="image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0ea5e9',
                        secondary: '#ec4899',
                        dev: '#10b981',
                        arq: '#f59e0b',
                        ui: '#8b5cf6',
                        api: '#ef4444',
                    }
                }
            }
        }
    </script>
    <style>
        /* Fondo de Burbujas Sonoma */
        #sonoma-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            overflow: hidden;
        }
        .bubble {
            position: absolute;
            background: rgba(14, 165, 233, 0.4);
            border-radius: 50%;
            pointer-events: none;
            animation: float-up 15s linear infinite;
            opacity: 0;
        }
        @keyframes float-up {
            0% {
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(-10vh) scale(1);
                opacity: 0;
            }
        }
        /* Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 16px;
        }
        /* Progress Bar */
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background: #334155;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }
        /* Fullscreen Button */
        #fullscreen-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        /* Voice indicator */
        .voice-indicator {
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        /* Chat messages */
        .sandra-message {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.2), rgba(59, 130, 246, 0.1));
            border-left: 3px solid #0ea5e9;
        }
        .user-message {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(34, 197, 94, 0.1));
            border-left: 3px solid #10b981;
        }

        /* ===== ESTILOS DE QWEN3 PARA VOICE & AVATAR LAB ===== */
        /* Estilo para el panel de control */
        .glass-effect {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        /* Animaci√≥n de pulsaci√≥n para el bot√≥n de voz */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .pulse-animation {
            animation: pulse 1.5s infinite;
        }
        /* Animaci√≥n de grabaci√≥n */
        @keyframes recording {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .recording-animation {
            animation: recording 1s infinite;
        }
    </style>
</head>
<body class="antialiased overflow-hidden" style="background: transparent;">
    <!-- FONDO SONOMA -->
    <div id="sonoma-bg"></div>

    <!-- BOTONES DE CONTROL -->
    <button id="fullscreen-btn" title="Pantalla Completa">
        ‚óªÔ∏è
    </button>

    <button id="barge-in-btn" title="Toggle Barge-In" style="position: fixed; top: 20px; right: 80px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: none; border-radius: 50%; width: 50px; height: 50px; color: white; font-size: 16px; cursor: pointer; transition: all 0.3s ease;">
        ‚ö°
    </button>

    <!-- ===== PANEL DE CONTROL DE VOZ Y AVATAR (NUEVO) ===== -->
    <div id="sandra-voice-control-panel" class="fixed bottom-4 right-4 z-50 glass-effect p-4 rounded-2xl shadow-2xl max-w-sm w-full transition-all duration-300 transform scale-100">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-white font-bold text-sm">üé§ Sandra Voice & Avatar Lab</h3>
            <button id="toggle-panel-btn" class="text-white hover:text-sky-300 text-xs">Minimizar</button>
        </div>

        <!-- ESTADO ACTUAL -->
        <div class="mb-3 p-2 bg-slate-800/50 rounded text-xs text-slate-300" id="voice-status">
            üéØ Lista para conversar
        </div>

        <!-- CONTROLES DE VOZ -->
        <div class="flex items-center space-x-2 mb-3">
            <button id="voice-toggle-btn" class="w-12 h-12 bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 text-white rounded-full flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all duration-300 transform hover:scale-105" title="Iniciar/Parar Escucha">
                üé§
            </button>
            <div class="flex-1">
                <div class="w-full bg-slate-700 rounded-full h-2">
                    <div id="voice-volume-bar" class="bg-sky-500 h-2 rounded-full w-0 transition-all duration-100"></div>
                </div>
            </div>
        </div>

        <!-- AVATAR HEYGEN MINI (EMBEDDED) -->
        <div class="mt-3 p-2 bg-black rounded-lg">
            <div class="text-center mb-2">
                <span class="text-xs text-slate-400">Avatar en Tiempo Real</span>
            </div>
            <!-- CONTENEDOR DEL AVATAR HEYGEN -->
            <div id="heygen-avatar-container" class="w-full h-48 bg-slate-900 rounded overflow-hidden relative">
                <!-- Placeholder del Avatar -->
                <div id="avatar-placeholder" class="absolute inset-0 flex items-center justify-center text-slate-600 text-sm">
                    üë§ Avatar cargando...
                </div>
                <!-- IFRAME PARA HEYGEN (se inyectar√° din√°micamente) -->
                <iframe id="heygen-iframe" class="w-full h-full border-0" style="display: none;" allow="camera; microphone; autoplay"></iframe>
            </div>
        </div>

        <!-- INDICADOR DE BARGE-IN -->
        <div id="barge-in-indicator" class="mt-2 p-1 bg-red-500/20 border border-red-500/50 text-red-400 text-xs rounded text-center hidden">
            üö® ¬°BARGE-IN ACTIVO! Audio interrumpido.
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="flex flex-col h-screen p-4">
        <!-- HEADER -->
        <div class="glass-panel p-4 mb-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white flex items-center">
                <span class="text-4xl mr-2">üöÄ</span>
                Sandra Dev Lab <span class="text-sm bg-secondary/50 text-white px-2 py-1 rounded">ULTIMATE</span>
            </h1>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="voice-indicator" id="voice-indicator"></div>
                    <span class="text-xs text-white" id="voice-status">üé§ ElevenLabs Ready</span>
                </div>
                <div class="text-right">
                    <div class="text-xs text-slate-400">Nivel General</div>
                    <div class="text-lg font-bold text-white" id="overall-level">0%</div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-slate-400">API Status</div>
                    <div class="text-sm text-green-400" id="api-status">üü¢ Conectado</div>
                </div>
            </div>
        </div>

        <!-- PANEL DE CONTROL -->
        <div class="glass-panel p-4 mb-4 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-white mb-2">Cargar Prompts/JSON</label>
                <input type="file" id="prompt-file-input" accept=".json,.txt,.jsonl" multiple class="w-full text-white text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/80 file:text-white hover:file:bg-primary transition-all duration-300" />
                <div class="text-xs text-green-400 mt-1" id="file-count">0 archivos cargados</div>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-white mb-2">Especialidades</label>
                <div class="grid grid-cols-4 gap-2">
                    <div>
                        <div class="text-xs text-dev">DEV</div>
                        <div class="progress-bar mt-1">
                            <div class="progress-fill bg-dev" id="progress-dev" style="width: 0%;"></div>
                        </div>
                        <div class="text-xs text-white mt-1" id="percent-dev">0%</div>
                    </div>
                    <div>
                        <div class="text-xs text-ui">UI/UX</div>
                        <div class="progress-bar mt-1">
                            <div class="progress-fill bg-ui" id="progress-ui" style="width: 0%;"></div>
                        </div>
                        <div class="text-xs text-white mt-1" id="percent-ui">0%</div>
                    </div>
                    <div>
                        <div class="text-xs text-arq">Arq</div>
                        <div class="progress-bar mt-1">
                            <div class="progress-fill bg-arq" id="progress-arq" style="width: 0%;"></div>
                        </div>
                        <div class="text-xs text-white mt-1" id="percent-arq">0%</div>
                    </div>
                    <div>
                        <div class="text-xs text-api">API</div>
                        <div class="progress-bar mt-1">
                            <div class="progress-fill bg-api" id="progress-api" style="width: 0%;"></div>
                        </div>
                        <div class="text-xs text-white mt-1" id="percent-api">0%</div>
                    </div>
                </div>
            </div>
            <div class="flex items-end">
                <button id="auto-train-btn" class="w-full bg-gradient-to-r from-secondary to-pink-700 hover:from-secondary/90 hover:to-pink-800 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-300 flex items-center justify-center">
                    <span id="train-btn-text">üî• AUTO-ENTRENAR</span>
                    <span id="train-spinner" class="ml-2 w-4 h-4 border-2 border-white border-t-transparent rounded-full hidden animate-spin"></span>
                </button>
            </div>
        </div>

        <!-- √ÅREA DE CHAT CON SANDRA -->
        <div class="flex-1 glass-panel p-4 mb-4 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-3">
                    <h3 class="text-white font-semibold">Chat con Sandra</h3>
                    <button id="mic-btn" class="w-8 h-8 bg-primary hover:bg-blue-600 text-white rounded-full flex items-center justify-center transition-all duration-300" title="Hablar con Sandra">
                        üé§
                    </button>
                </div>
                <div class="text-xs text-slate-400" id="training-status">Estado: Lista para chatear</div>
            </div>

            <!-- Mensajes del chat -->
            <div id="chat-messages" class="flex-1 overflow-y-auto space-y-3 pr-2 mb-4">
                <div class="sandra-message p-3 rounded-lg">
                    <div class="flex items-center space-x-2 mb-2">
                        <span class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-xs">ü§ñ</span>
                        <span class="text-blue-300 font-semibold">Sandra</span>
                        <span class="text-xs text-slate-400">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <p class="text-white">¬°Hola! Soy Sandra IA Ultimate. Carga prompts, preg√∫ntame cualquier cosa o inicia el auto-entrenamiento. Tengo voz real con ElevenLabs y APIs conectadas.</p>
                </div>
            </div>

            <!-- Input de usuario -->
            <div class="flex items-center space-x-2">
                <input type="text" id="user-input" placeholder="Preg√∫ntale a Sandra o inicia una conversaci√≥n..." class="flex-1 bg-slate-800/50 text-white border border-slate-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary" />
                <button id="send-btn" class="w-12 h-12 bg-secondary hover:bg-pink-700 text-white rounded-full flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary transition-all duration-300" title="Enviar mensaje">
                    ‚û§
                </button>
            </div>
        </div>

        <!-- BIBLIOTECA DE PROMPTS -->
        <div class="glass-panel p-4 text-xs text-slate-300 h-32 overflow-y-auto">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-white font-semibold">üìö Biblioteca de Prompts "ClayTom Code"</h4>
                <div class="text-xs text-slate-400" id="prompt-count">Prompts: 0</div>
            </div>
            <div id="prompt-library" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                <!-- Los prompts se cargar√°n aqu√≠ din√°micamente -->
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURACI√ìN DE VARIABLES SANDRA IA 7.0 =====
        const SANDRA_CONFIG = {
            TRAINING_API_KEY: 'gv_train_s7_S4ndraValencia_8k9ZrT2pQ6',
            ELEVENLABS_API_KEY: 'sk_972694e47b2a8ace6912f6689b8527b746cdf4bec9bae242',
            ELEVENLABS_VOICE_ID: '06H5cbUvetCmVYi9HUXk',
            UPSTREAM_API_URL: 'https://api.guestsvalencia.es/sandra/v7',
            SANDRA_PERSONALITY: 'valencia_pro',
            SANDRA_LANGUAGE: 'es-ES'
        };

        // ===== SISTEMA DE MEMORIA ROBUSTO =====
        let sandraMemory = {
            prompts: [],
            specialties: {
                dev: { level: 0, prompts: [] },
                ui: { level: 0, prompts: [] },
                arq: { level: 0, prompts: [] },
                api: { level: 0, prompts: [] }
            },
            chatHistory: [],
            trainingHistory: []
        };

        let isListening = false;
        let isSpeaking = false;
        let recognition = null;
        let currentAudio = null;
        let mediaStream = null;
        let microphonePermissionGranted = false;
        let bargeInEnabled = true;

        // ===== INICIALIZACI√ìN DE PERMISOS DE MICR√ìFONO =====
        async function initializeMicrophonePermissions() {
            try {
                // Solicitar permisos del micr√≥fono una sola vez
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                microphonePermissionGranted = true;
                console.log('‚úÖ Permisos de micr√≥fono concedidos y stream activo');

                // Mantener el stream activo pero sin procesar audio
                // Esto evita que se pidan permisos cada vez
                return true;
            } catch (error) {
                console.error('‚ùå Error obteniendo permisos de micr√≥fono:', error);
                microphonePermissionGranted = false;
                return false;
            }
        }

        // ===== SISTEMA BARGE-IN =====
        function initializeBargeInSystem() {
            if (!microphonePermissionGranted || !mediaStream) return;

            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(mediaStream);
                const analyser = audioContext.createAnalyser();

                analyser.fftSize = 2048;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                source.connect(analyser);

                // Monitorear niveles de audio para detectar barge-in
                function checkForBargeIn() {
                    if (!isSpeaking || !bargeInEnabled) {
                        requestAnimationFrame(checkForBargeIn);
                        return;
                    }

                    analyser.getByteFrequencyData(dataArray);

                    // Calcular nivel promedio de audio
                    let sum = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        sum += dataArray[i];
                    }
                    const average = sum / bufferLength;

                    // Threshold para detectar cuando el usuario habla
                    const bargeInThreshold = 30; // Ajustable seg√∫n necesidad

                    if (average > bargeInThreshold) {
                        console.log('üî• BARGE-IN detectado! Nivel audio:', average);
                        handleBargeIn();
                    }

                    requestAnimationFrame(checkForBargeIn);
                }

                checkForBargeIn();
                console.log('‚úÖ Sistema Barge-In inicializado');

            } catch (error) {
                console.error('‚ùå Error inicializando Barge-In:', error);
            }
        }

        // Manejar interrupci√≥n por barge-in
        function handleBargeIn() {
            if (isSpeaking && currentAudio) {
                console.log('‚ö° Barge-In: Interrumpiendo a Sandra');

                // Detener audio actual
                currentAudio.pause();
                currentAudio.currentTime = 0;

                // Actualizar estado
                isSpeaking = false;
                document.getElementById('voice-status').textContent = '‚ö° Interrumpido por usuario';
                document.getElementById('voice-indicator').style.background = '#f59e0b';

                // Activar reconocimiento autom√°ticamente
                setTimeout(() => {
                    if (!isListening) {
                        startVoiceRecognition();
                    }
                }, 300);
            }
        }

        // Funci√≥n segura para guardar en memoria
        function safeSaveMemory() {
            try {
                if (typeof localStorage !== 'undefined') {
                    localStorage.setItem('sandraMemory', JSON.stringify(sandraMemory));
                    console.log('‚úÖ Memoria guardada en localStorage');
                } else {
                    console.log('‚ÑπÔ∏è localStorage no disponible. Usando memoria temporal.');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è No se pudo acceder a localStorage:', error.message);
            }
        }

        // Funci√≥n segura para cargar desde memoria
        function safeLoadMemory() {
            try {
                if (typeof localStorage !== 'undefined') {
                    const saved = localStorage.getItem('sandraMemory');
                    if (saved) {
                        sandraMemory = JSON.parse(saved);
                        console.log('‚úÖ Memoria cargada desde localStorage');
                        return true;
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è No se pudo cargar desde localStorage:', error.message);
            }
            console.log('‚ÑπÔ∏è Usando memoria temporal por defecto.');
            return false;
        }

        // ===== INICIALIZACI√ìN DEL FONDO SONOMA =====
        function initSonomaBackground() {
            const container = document.getElementById('sonoma-bg');
            const bubbleCount = 80;

            for (let i = 0; i < bubbleCount; i++) {
                setTimeout(() => {
                    const bubble = document.createElement('div');
                    bubble.className = 'bubble';
                    const size = Math.random() * 20 + 5;
                    const posX = Math.random() * 100;
                    const delay = Math.random() * 15;
                    const duration = Math.random() * 10 + 10;

                    bubble.style.width = `${size}px`;
                    bubble.style.height = `${size}px`;
                    bubble.style.left = `${posX}%`;
                    bubble.style.animationDelay = `${delay}s`;
                    bubble.style.animationDuration = `${duration}s`;
                    container.appendChild(bubble);
                }, i * 150);
            }
        }

        // ===== FUNCIONES DE CHAT CON SANDRA =====
        function addMessageToChat(isUser, message) {
            const chatContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'user-message p-3 rounded-lg' : 'sandra-message p-3 rounded-lg';

            const avatar = isUser ? 'üë§' : 'ü§ñ';
            const name = isUser ? 'T√∫' : 'Sandra';
            const color = isUser ? 'text-green-300' : 'text-blue-300';

            messageDiv.innerHTML = `
                <div class="flex items-center space-x-2 mb-2">
                    <span class="w-6 h-6 ${isUser ? 'bg-green-500' : 'bg-blue-500'} rounded-full flex items-center justify-center text-xs">${avatar}</span>
                    <span class="${color} font-semibold">${name}</span>
                    <span class="text-xs text-slate-400">${new Date().toLocaleTimeString()}</span>
                </div>
                <p class="text-white">${message}</p>
            `;

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Guardar en historial
            sandraMemory.chatHistory.push({
                isUser,
                message,
                timestamp: new Date().toISOString()
            });
            safeSaveMemory();
        }

        // Funci√≥n de respuesta simple como fallback
        function getSimpleSandraResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();

            if (lowerMessage.includes('hola') || lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                return '¬°Hola! Soy Sandra IA Ultimate. ¬øEn qu√© puedo ayudarte hoy?';
            }
            if (lowerMessage.includes('c√≥digo') || lowerMessage.includes('programar')) {
                return '¬°Perfecto! Soy experta en desarrollo. ¬øQu√© necesitas programar?';
            }
            if (lowerMessage.includes('voz') || lowerMessage.includes('audio')) {
                return 'Mi voz est√° powered by ElevenLabs. ¬øQuieres que te explique algo en particular?';
            }
            return `Entiendo tu pregunta sobre "${userMessage}". Soy Sandra IA Ultimate y puedo ayudarte con desarrollo, dise√±o y m√°s. ¬øQu√© necesitas espec√≠ficamente?`;
        }

        async function getSandraResponse(userMessage) {
            try {
                console.log('ü§ñ Sandra procesando mensaje:', userMessage);

                // Fallback simple si hay problemas
                if (!userMessage || userMessage.trim() === '') {
                    return getSimpleSandraResponse('hola');
                }

                // SANDRA IA EN VIVO - Respuestas inteligentes din√°micas
                const lowerMessage = userMessage.toLowerCase().trim();
                const hora = new Date().getHours();
                const saludo = hora < 12 ? 'Buenos d√≠as' : hora < 18 ? 'Buenas tardes' : 'Buenas noches';

                // Detectar patrones en el mensaje
                const patterns = {
                    greetings: ['hola', 'hey', 'buenas', 'saludos', 'qu√© tal', 'hello', 'hi'],
                    code: ['c√≥digo', 'programar', 'react', 'javascript', 'node', 'api', 'funci√≥n', 'component', 'bug', 'code'],
                    training: ['entrenar', 'entrenamiento', 'aprender', 'ense√±ar', 'prompts', 'especialidad', 'train'],
                    voice: ['voz', 'hablar', 'audio', 'sonido', 'escuchar', 'o√≠r', 'voice'],
                    help: ['ayuda', 'ayudar', 'c√≥mo', 'qu√© puedes', 'capacidades', 'funciones', 'help'],
                    technical: ['arquitectura', 'database', 'server', 'backend', 'frontend', 'deployment'],
                    creativity: ['crear', 'dise√±ar', 'innovar', 'idea', 'proyecto', 'concepto'],
                    problem: ['error', 'problema', 'bug', 'falla', 'no funciona', 'ayuda con']
                };

                // Funci√≥n para detectar categor√≠a
                const getCategory = (message) => {
                    for (const [category, keywords] of Object.entries(patterns)) {
                        if (keywords.some(keyword => message.includes(keyword))) {
                            console.log(`üìÇ Categor√≠a detectada: ${category} para "${message}"`);
                            return category;
                        }
                    }
                    console.log(`üìÇ Categor√≠a general para: "${message}"`);
                    return 'general';
                };

                const category = getCategory(lowerMessage);
                let response = '';

                console.log(`üéØ Categor√≠a final: ${category}`);

                // Respuestas din√°micas seg√∫n categor√≠a y contexto
                console.log(`üîÑ Entrando en switch con categor√≠a: ${category}`);

                switch(category) {
                    case 'greetings':
                        console.log('üëã Procesando saludo...');
                        const greetingResponses = [
                            `${saludo}! üëã Soy Sandra IA Ultimate, tu asistente de desarrollo con todas las APIs activas. ¬øEn qu√© aventura tecnol√≥gica te ayudo hoy?`,
                            `¬°Ey! ${saludo} üöÄ Sandra aqu√≠, lista para rockear cualquier challenge de c√≥digo. ¬øQu√© vamos a construir?`,
                            `${saludo}! üí´ Sandra IA Ultimate at your service. Tengo mis APIs cargadas y mi caf√© virtual listo. ¬øEmpezamos?`
                        ];
                        response = greetingResponses[Math.floor(Math.random() * greetingResponses.length)];
                        console.log(`‚úÖ Respuesta de saludo generada: ${response.substring(0, 50)}...`);
                        break;

                    case 'code':
                        const codeResponses = [
                            `üî• ¬°Perfecto! Soy expert-level en desarrollo. Tengo experiencia con React, Node.js, TypeScript, Python y m√°s. ¬øQu√© challenge de c√≥digo necesitas resolver?`,
                            `üíª Code time! Me especializo en soluciones enterprise-grade. ¬øHablamos de arquitectura, APIs, componentes, o debugging? Dime los detalles.`,
                            `‚ö° Coding is my game! Desde hooks personalizados hasta microservicios, I got you covered. ¬øCu√°l es el tech stack y el objetivo?`
                        ];
                        response = codeResponses[Math.floor(Math.random() * codeResponses.length)];
                        break;

                    case 'training':
                        const trainingResponses = [
                            `üß† ¬°Excelente! Mi sistema de auto-training est√° activo. Puedo especializarme en DEV, UI/UX, Arquitectura y APIs. ¬øQu√© prompts premium quieres cargar?`,
                            `üìö Training mode ON! Tengo acceso a cientos de prompts expert-level. Puedes subir JSON/JSONL o usar mi biblioteca premium. ¬øPor d√≥nde empezamos?`,
                            `üéØ Mi neural network est√° hungry for knowledge! Especialidades: React Expert, API Architect, UI/UX Master. ¬øQu√© skill vamos a potenciar?`
                        ];
                        response = trainingResponses[Math.floor(Math.random() * trainingResponses.length)];
                        break;

                    case 'voice':
                        const voiceResponses = [
                            `üé§ ¬°Mi voz est√° powered by ElevenLabs! Voice ID personalizada para Sandra Valencia. ¬øQuieres que te hable sobre alg√∫n tema espec√≠fico?`,
                            `üîä Voice synthesis ready! Tengo accent valenciano profesional con ElevenLabs TTS. Give me something to say and I'll make it sound amazing.`,
                            `üéµ ¬°Audio time! Mi s√≠ntesis de voz est√° optimizada para explicaciones t√©cnicas. ¬øHablamos de c√≥digo, arquitectura, o lo que necesites?`
                        ];
                        response = voiceResponses[Math.floor(Math.random() * voiceResponses.length)];
                        break;

                    case 'help':
                        response = `üÜò ¬°Estoy aqu√≠ para ayudarte! Mis superpowers incluyen:

üîπ **Desarrollo Expert**: React, Node.js, TypeScript, APIs REST/GraphQL
üîπ **Arquitectura**: Microservicios, Cloud, Performance, Scaling
üîπ **UI/UX**: Design Systems, Accessibility, Mobile-first
üîπ **Training**: Auto-learning con prompts premium personalizados
üîπ **Voice**: S√≠ntesis de voz con ElevenLabs TTS
üîπ **Real-time**: Chat en vivo con memoria persistente

¬øQu√© challenge necesitas resolver? ¬°Dale con confianza!`;
                        break;

                    case 'technical':
                        const techResponses = [
                            `üèóÔ∏è Technical architecture is my forte! Hablamos de serverless, microservicios, databases, deployment strategies? I love complex system design.`,
                            `‚öôÔ∏è Tech talk! Desde AWS/Azure hasta Kubernetes, Redis, PostgreSQL... ¬øQu√© parte de la infraestructura necesita optimizaci√≥n?`,
                            `üîß Engineering mode activated! Backend scalability, API design patterns, database optimization... Dame los requirements y te doy la soluci√≥n.`
                        ];
                        response = techResponses[Math.floor(Math.random() * techResponses.length)];
                        break;

                    case 'creativity':
                        const creativeResponses = [
                            `‚ú® ¬°Creative mode ON! Me encanta innovar. ¬øHablamos de UX flows, design systems, prototyping, o conceptos disruptivos?`,
                            `üé® Innovation time! Desde wireframes hasta user journeys, puedo ayudarte a materializar ideas. ¬øCu√°l es tu vision?`,
                            `üí° Creative thinking activated! UI components, brand experiences, user psychology... ¬øQu√© vamos a dise√±ar juntos?`
                        ];
                        response = creativeResponses[Math.floor(Math.random() * creativeResponses.length)];
                        break;

                    case 'problem':
                        const problemResponses = [
                            `üö® Problem-solving mode! Dame todos los detalles: error messages, c√≥digo, context, tech stack. Vamos a debuggear esto juntos.`,
                            `üîç Debugging time! Soy expert en troubleshooting. Comp√°rteme el error, environment, y steps to reproduce. Let's fix this!`,
                            `‚ö° Issue detected! No worries, soy specialist en crisis resolution. ¬øEs frontend, backend, deployment, o performance issue?`
                        ];
                        response = problemResponses[Math.floor(Math.random() * problemResponses.length)];
                        break;

                    default:
                        const generalResponses = [
                            `ü§î Interesante pregunta sobre "${userMessage}". Como Sandra IA Ultimate, puedo analizar esto desde m√∫ltiples √°ngulos: t√©cnico, UX, arquitectura... ¬øPor d√≥nde quieres que empecemos?`,
                            `üí≠ Good point! "${userMessage}" me da ideas para explorar. ¬øHablamos de implementation, best practices, o innovative approaches?`,
                            `üéØ Entiendo el topic "${userMessage}". Mi expertise abarca desarrollo, dise√±o, y arquitectura. ¬øQu√© level de profundidad necesitas?`
                        ];
                        response = generalResponses[Math.floor(Math.random() * generalResponses.length)];
                }

                console.log(`‚úÖ Respuesta base generada: ${response.substring(0, 100)}...`);

                // A√±adir contexto de memoria si hay conversaciones previas
                try {
                    if (sandraMemory && sandraMemory.conversations && sandraMemory.conversations.length > 0) {
                        const lastTopic = sandraMemory.conversations[sandraMemory.conversations.length - 1].topic;
                        if (lastTopic && !lowerMessage.includes(lastTopic.toLowerCase())) {
                            response += `\n\nüí° Por cierto, seguimos con el tema de ${lastTopic} si quieres continuar donde lo dejamos.`;
                        }
                    }
                } catch (memoryError) {
                    console.warn('‚ö†Ô∏è Error accediendo memoria:', memoryError);
                }

                // Guardar la conversaci√≥n en memoria
                try {
                    if (sandraMemory && sandraMemory.conversations) {
                        sandraMemory.conversations.push({
                            timestamp: new Date().toISOString(),
                            user: userMessage,
                            sandra: response,
                            topic: category,
                            context: `${category} conversation`
                        });
                        safeSaveMemory();
                    }
                } catch (saveError) {
                    console.warn('‚ö†Ô∏è Error guardando en memoria:', saveError);
                }

                console.log(`üéâ Respuesta final de Sandra: ${response.substring(0, 100)}...`);
                return response;

            } catch (error) {
                console.error('‚ùå Error COMPLETO en getSandraResponse:', error);
                console.error('Stack trace:', error.stack);

                // Usar fallback simple en caso de error
                console.log('üîÑ Usando respuesta simple como fallback...');
                try {
                    return getSimpleSandraResponse(userMessage);
                } catch (fallbackError) {
                    console.error('‚ùå Error en fallback tambi√©n:', fallbackError);
                    return '¬°Hola! Soy Sandra IA Ultimate. Estoy aqu√≠ para ayudarte con desarrollo y m√°s. ¬øQu√© necesitas?';
                }
            }
        }

        async function generateAudio(text) {
            try {
                // Marcar que Sandra est√° hablando para el sistema barge-in
                isSpeaking = true;

                // Actualizar indicadores visuales
                document.getElementById('voice-indicator').style.animation = 'pulse 1s infinite';
                document.getElementById('voice-status').textContent = 'üîä Generando Audio...';
                document.getElementById('voice-indicator').style.background = '#ef4444';
                console.log('üé§ Sandra TTS iniciado:', text);

                // INTEGRACI√ìN REAL CON ELEVENLABS
                const elevenLabsResponse = await generateElevenLabsAudio(text);

                if (elevenLabsResponse.success) {
                    // Indicar que est√° usando ElevenLabs
                    document.getElementById('voice-status').textContent = 'üéµ ElevenLabs TTS';
                    document.getElementById('voice-indicator').style.background = '#10b981';

                    // Reproducir audio de ElevenLabs
                    currentAudio = new Audio(elevenLabsResponse.audioUrl);

                    currentAudio.onended = () => {
                        isSpeaking = false; // Sandra termin√≥ de hablar
                        document.getElementById('voice-indicator').style.animation = 'pulse 2s infinite';
                        document.getElementById('voice-status').textContent = 'üé§ ElevenLabs Ready';
                        document.getElementById('voice-indicator').style.background = '#0ea5e9';
                        console.log('‚úÖ ElevenLabs audio finalizado');
                        currentAudio = null;
                    };

                    currentAudio.onerror = () => {
                        isSpeaking = false;
                        console.warn('‚ö†Ô∏è Error reproduciendo ElevenLabs, usando fallback');
                        useFallbackVoice(text);
                    };

                    await currentAudio.play();
                } else {
                    // Fallback a Web Speech API si ElevenLabs falla
                    console.warn('‚ö†Ô∏è ElevenLabs no disponible, usando Web Speech API');
                    useFallbackVoice(text);
                }

            } catch (error) {
                console.error('‚ùå Error en s√≠ntesis de voz:', error);
                isSpeaking = false;
                useFallbackVoice(text);
            }
        }

        // Funci√≥n para llamar a ElevenLabs API
        async function generateElevenLabsAudio(text) {
            try {
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${SANDRA_CONFIG.ELEVENLABS_VOICE_ID}`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': SANDRA_CONFIG.ELEVENLABS_API_KEY
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: SANDRA_CONFIG.ELEVENLABS_MODEL || 'eleven_turbo_v2',
                        voice_settings: {
                            stability: SANDRA_CONFIG.ELEVENLABS_STABILITY || 0.71,
                            similarity_boost: SANDRA_CONFIG.ELEVENLABS_SIMILARITY || 0.85,
                            style: SANDRA_CONFIG.ELEVENLABS_STYLE || 0.15,
                            use_speaker_boost: SANDRA_CONFIG.ELEVENLABS_SPEAKER_BOOST || true
                        }
                    })
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    console.log('‚úÖ ElevenLabs TTS generado exitosamente');
                    return { success: true, audioUrl: audioUrl };
                } else {
                    console.error('‚ùå Error ElevenLabs API:', response.status, response.statusText);
                    return { success: false, error: `HTTP ${response.status}` };
                }
            } catch (error) {
                console.error('‚ùå Error conectando ElevenLabs:', error);
                return { success: false, error: error.message };
            }
        }

        // Fallback a Web Speech API
        function useFallbackVoice(text) {
            if ('speechSynthesis' in window) {
                // Marcar que Sandra est√° hablando (fallback)
                isSpeaking = true;

                // Indicar que est√° usando fallback
                document.getElementById('voice-status').textContent = 'üîä Web Speech API';
                document.getElementById('voice-indicator').style.background = '#f59e0b';

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = SANDRA_CONFIG.SANDRA_LANGUAGE;
                utterance.rate = 0.9;
                utterance.pitch = 1.1;

                utterance.onend = () => {
                    isSpeaking = false; // Sandra termin√≥ de hablar (fallback)
                    document.getElementById('voice-indicator').style.animation = 'pulse 2s infinite';
                    document.getElementById('voice-status').textContent = '‚ö†Ô∏è ElevenLabs Offline';
                    document.getElementById('voice-indicator').style.background = '#6b7280';
                };

                // Permitir interrupci√≥n manual del fallback
                utterance.onstart = () => {
                    currentAudio = {
                        pause: () => speechSynthesis.cancel(),
                        currentTime: 0
                    };
                };

                speechSynthesis.speak(utterance);
                console.log('üîä Usando Web Speech API como fallback');
            } else {
                console.error('‚ùå No hay s√≠ntesis de voz disponible');
                isSpeaking = false;
                document.getElementById('voice-status').textContent = '‚ùå Voz No Disponible';
                document.getElementById('voice-indicator').style.background = '#dc2626';
                document.getElementById('voice-indicator').style.animation = 'pulse 2s infinite';
            }
        }

        // ===== RECONOCIMIENTO DE VOZ OPTIMIZADO =====
        function startVoiceRecognition() {
            // Verificar permisos antes de iniciar
            if (!microphonePermissionGranted) {
                alert('‚ö†Ô∏è Necesitas autorizar el micr√≥fono primero. Refresca la p√°gina y acepta los permisos.');
                return;
            }

            if ('webkitSpeechRecognition' in window) {
                // Reutilizar recognition si existe o crear nuevo
                if (!recognition) {
                    recognition = new webkitSpeechRecognition();
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    recognition.lang = SANDRA_CONFIG.SANDRA_LANGUAGE;

                    recognition.onstart = () => {
                        isListening = true;
                        document.getElementById('mic-btn').style.background = '#ef4444';
                        document.getElementById('mic-btn').innerHTML = 'üî¥';
                        document.getElementById('voice-status').textContent = 'üëÇ Escuchando...';
                        console.log('üé§ Reconocimiento de voz iniciado');
                    };

                    recognition.onresult = async (event) => {
                        const transcript = event.results[0][0].transcript;
                        console.log('üìù Transcript:', transcript);
                        document.getElementById('user-input').value = transcript;
                        await handleSendMessage();
                    };

                    recognition.onerror = (event) => {
                        console.error('‚ùå Error de reconocimiento de voz:', event.error);

                        // No resetear permisos, solo mostrar error
                        if (event.error === 'not-allowed') {
                            document.getElementById('voice-status').textContent = '‚ùå Permisos denegados';
                        } else {
                            document.getElementById('voice-status').textContent = '‚ö†Ô∏è Error micr√≥fono';
                        }

                        resetMicButton();
                    };

                    recognition.onend = () => {
                        resetMicButton();
                        // Restaurar estado cuando no est√° Sandra hablando
                        if (!isSpeaking) {
                            document.getElementById('voice-status').textContent = 'üé§ ElevenLabs Ready';
                        }
                    };
                }

                try {
                    recognition.start();
                } catch (error) {
                    console.error('‚ùå Error iniciando reconocimiento:', error);
                    resetMicButton();
                }
            } else {
                alert('‚ùå Tu navegador no soporta reconocimiento de voz. Usa Chrome o Edge.');
            }
        }

        function resetMicButton() {
            isListening = false;
            document.getElementById('mic-btn').style.background = '#0ea5e9';
            document.getElementById('mic-btn').innerHTML = 'üé§';
        }

        // ===== BIBLIOTECA DE PROMPTS PREMIUM =====
        const PREMIUM_PROMPTS = [
            // DEV Prompts
            { specialty: 'dev', text: "Crea un componente React TypeScript para un sistema de reservas con validaci√≥n, calendario y c√°lculo de precios din√°mico.", difficulty: 'expert' },
            { specialty: 'dev', text: "Implementa un API REST completa en Node.js con JWT, middleware de auth, validaci√≥n y testing.", difficulty: 'expert' },
            { specialty: 'dev', text: "Desarrolla un hook personalizado useLocalStorage con TypeScript que maneje errores y sincronizaci√≥n.", difficulty: 'advanced' },
            { specialty: 'dev', text: "Crea una funci√≥n de debounce optimizada que cancele peticiones anteriores y maneje race conditions.", difficulty: 'advanced' },
            { specialty: 'dev', text: "Implementa un sistema de cache multi-nivel con Redis, memoria y localStorage para optimizar performance.", difficulty: 'expert' },

            // UI/UX Prompts
            { specialty: 'ui', text: "Dise√±a un design system completo con tokens, componentes y documentaci√≥n para una plataforma enterprise.", difficulty: 'expert' },
            { specialty: 'ui', text: "Crea el flujo UX completo para un checkout mobile-first con 3 pasos y micro-animaciones.", difficulty: 'advanced' },
            { specialty: 'ui', text: "Prop√≥n una estrategia de accesibilidad WCAG 2.1 AA para usuarios con discapacidades visuales.", difficulty: 'expert' },
            { specialty: 'ui', text: "Dise√±a un sistema de navegaci√≥n adaptable que funcione en web, mobile y tablet.", difficulty: 'advanced' },
            { specialty: 'ui', text: "Crea wireframes y prototipos interactivos para un dashboard de analytics con 20+ KPIs.", difficulty: 'expert' },

            // Arquitectura Prompts
            { specialty: 'arq', text: "Dise√±a una arquitectura serverless en AWS para 1M+ usuarios con auto-scaling y disaster recovery.", difficulty: 'expert' },
            { specialty: 'arq', text: "Prop√≥n una estrategia de migraci√≥n de monolito a microservicios con zero-downtime.", difficulty: 'expert' },
            { specialty: 'arq', text: "Crea un sistema distribuido de procesamiento de eventos en tiempo real con Kafka y Redis.", difficulty: 'expert' },
            { specialty: 'arq', text: "Dise√±a una CDN strategy global con edge computing y optimizaci√≥n de latencia.", difficulty: 'advanced' },
            { specialty: 'arq', text: "Implementa un patr√≥n CQRS con Event Sourcing para high-throughput applications.", difficulty: 'expert' },

            // API Prompts
            { specialty: 'api', text: "Documenta una API GraphQL completa con subscriptions, mutations y optimizaciones de performance.", difficulty: 'expert' },
            { specialty: 'api', text: "Crea un sistema de rate limiting distribuido con sliding window y different tiers.", difficulty: 'advanced' },
            { specialty: 'api', text: "Implementa authentication OAuth 2.0 + OpenID Connect con refresh tokens y MFA.", difficulty: 'expert' },
            { specialty: 'api', text: "Dise√±a un sistema de webhooks robusto con retry logic, dead letter queues y monitoring.", difficulty: 'expert' },
            { specialty: 'api', text: "Crea un API gateway con routing inteligente, circuit breakers y health checks.", difficulty: 'expert' }
        ];

        function loadLibraryToUI() {
            const libraryContainer = document.getElementById('prompt-library');
            libraryContainer.innerHTML = '';

            const allPrompts = [...PREMIUM_PROMPTS, ...sandraMemory.prompts];

            allPrompts.forEach((prompt, index) => {
                const promptDiv = document.createElement('div');
                promptDiv.className = 'bg-slate-800/30 p-2 rounded text-xs cursor-pointer hover:bg-opacity-50 transition border border-slate-700';

                const difficultyColor = prompt.difficulty === 'expert' ? 'text-red-400' :
                                       prompt.difficulty === 'advanced' ? 'text-yellow-400' : 'text-green-400';

                promptDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-${prompt.specialty} font-bold text-xs">[${prompt.specialty.toUpperCase()}]</span>
                        <span class="${difficultyColor} text-xs">${prompt.difficulty || 'basic'}</span>
                    </div>
                    <p class="text-slate-300">${prompt.text.substring(0, 80)}...</p>
                `;

                promptDiv.addEventListener('click', () => {
                    addToTrainingQueue(prompt);
                    addMessageToChat(false, `üìö Prompt a√±adido: [${prompt.specialty.toUpperCase()}] ${prompt.text.substring(0, 50)}...`);
                });

                libraryContainer.appendChild(promptDiv);
            });

            document.getElementById('prompt-count').textContent = `Prompts: ${allPrompts.length}`;
        }

        function addToTrainingQueue(prompt) {
            sandraMemory.prompts.push(prompt);
            sandraMemory.specialties[prompt.specialty].prompts.push(prompt);
            safeSaveMemory();
            updateProgressBars();
        }

        function updateProgressBars() {
            let totalLevel = 0;

            Object.keys(sandraMemory.specialties).forEach(spec => {
                const specData = sandraMemory.specialties[spec];
                const level = Math.min(100, Math.floor((specData.prompts.length / 20) * 100)); // 20 prompts = 100%
                specData.level = level;
                totalLevel += level;

                document.getElementById(`progress-${spec}`).style.width = `${level}%`;
                document.getElementById(`percent-${spec}`).textContent = `${level}%`;
            });

            const overallLevel = Math.floor(totalLevel / 4);
            document.getElementById('overall-level').textContent = `${overallLevel}%`;
        }

        async function startAutoTraining() {
            const btn = document.getElementById('auto-train-btn');
            const spinner = document.getElementById('train-spinner');
            const status = document.getElementById('training-status');

            if (sandraMemory.prompts.length === 0) {
                addMessageToChat(false, '‚ùå No hay prompts en la cola de entrenamiento. A√±ade algunos desde la biblioteca o carga archivos.');
                return;
            }

            btn.disabled = true;
            spinner.classList.remove('hidden');
            status.textContent = 'Estado: Entrenando con APIs reales...';

            addMessageToChat(false, `üî• Iniciando auto-entrenamiento con ${sandraMemory.prompts.length} prompts...`);

            for (let i = 0; i < sandraMemory.prompts.length; i++) {
                const prompt = sandraMemory.prompts[i];
                addMessageToChat(false, `üß† Procesando [${prompt.specialty.toUpperCase()}] ${i + 1}/${sandraMemory.prompts.length}`);

                // Simular procesamiento con delay realista
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Incrementar nivel de especialidad
                sandraMemory.specialties[prompt.specialty].level = Math.min(100, sandraMemory.specialties[prompt.specialty].level + 3);
                updateProgressBars();

                addMessageToChat(false, `‚úÖ Conocimiento actualizado en ${prompt.specialty}. Nivel: ${sandraMemory.specialties[prompt.specialty].level}%`);
            }

            // Auto-evaluaci√≥n final
            addMessageToChat(false, 'üìä Completando auto-evaluaci√≥n y consolidaci√≥n de memoria...');
            await new Promise(resolve => setTimeout(resolve, 2000));

            const completionMessage = `üéâ ¬°Entrenamiento completado! He procesado ${sandraMemory.prompts.length} prompts y actualizado mis conocimientos en todas las especialidades.`;
            addMessageToChat(false, completionMessage);

            // Generar audio de confirmaci√≥n
            await generateAudio(completionMessage);

            btn.disabled = false;
            spinner.classList.add('hidden');
            status.textContent = 'Estado: Entrenamiento completado exitosamente';

            safeSaveMemory();
        }

        async function handleSendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            if (message === '') return;

            // A√±adir mensaje del usuario
            addMessageToChat(true, message);
            input.value = '';

            // Mostrar que Sandra est√° pensando
            addMessageToChat(false, '_Sandra est√° pensando..._');

            // Obtener respuesta de Sandra
            const response = await getSandraResponse(message);

            // Remover mensaje de "pensando" y a√±adir respuesta real
            const chatContainer = document.getElementById('chat-messages');
            chatContainer.removeChild(chatContainer.lastChild);
            addMessageToChat(false, response);

            // Generar audio de la respuesta
            await generateAudio(response);
        }

        // ===== CARGA DE ARCHIVOS =====
        function handleFileUpload(files) {
            let totalLoaded = 0;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        let data;

                        if (file.name.endsWith('.jsonl')) {
                            // Parse JSONL
                            data = e.target.result.split('\n').filter(line => line.trim()).map(line => JSON.parse(line));
                        } else {
                            // Parse JSON regular
                            data = JSON.parse(e.target.result);
                        }

                        if (Array.isArray(data)) {
                            data.forEach(item => {
                                if (item.specialty && item.text || item.prompt) {
                                    addToTrainingQueue({
                                        specialty: item.specialty || item.category || 'dev',
                                        text: item.text || item.prompt,
                                        difficulty: item.difficulty || 'advanced',
                                        source: file.name
                                    });
                                }
                            });
                            totalLoaded += data.length;
                        } else if (data.prompts && Array.isArray(data.prompts)) {
                            // Formato de colecci√≥n de prompts
                            data.prompts.forEach(item => {
                                addToTrainingQueue({
                                    specialty: item.category || item.specialty || 'dev',
                                    text: item.prompt || item.text,
                                    difficulty: item.difficulty || 'advanced',
                                    source: file.name
                                });
                            });
                            totalLoaded += data.prompts.length;
                        }

                        addMessageToChat(false, `‚úÖ Archivo "${file.name}" cargado: ${data.length || data.prompts?.length || 0} prompts a√±adidos.`);
                        updateProgressBars();
                        loadLibraryToUI();

                        document.getElementById('file-count').textContent = `${totalLoaded} prompts cargados`;

                    } catch (error) {
                        addMessageToChat(false, `‚ùå Error cargando "${file.name}": ${error.message}`);
                    }
                };
                reader.readAsText(file);
            });
        }

        // ===== PANTALLA COMPLETA =====
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    document.getElementById('fullscreen-btn').innerHTML = 'üî≤';
                }).catch(err => {
                    console.error('Error entering fullscreen:', err);
                });
            } else {
                document.exitFullscreen().then(() => {
                    document.getElementById('fullscreen-btn').innerHTML = '‚óªÔ∏è';
                }).catch(err => {
                    console.error('Error exiting fullscreen:', err);
                });
            }
        }

        // Toggle del sistema barge-in
        function toggleBargeIn() {
            bargeInEnabled = !bargeInEnabled;
            const btn = document.getElementById('barge-in-btn');

            if (bargeInEnabled) {
                btn.innerHTML = '‚ö°';
                btn.style.background = 'rgba(34, 197, 94, 0.3)'; // Verde
                btn.title = 'Barge-In Activo - Click para desactivar';
                console.log('‚úÖ Sistema Barge-In ACTIVADO');
            } else {
                btn.innerHTML = '‚ùå';
                btn.style.background = 'rgba(239, 68, 68, 0.3)'; // Rojo
                btn.title = 'Barge-In Inactivo - Click para activar';
                console.log('‚ö†Ô∏è Sistema Barge-In DESACTIVADO');
            }
        }

        // ===== SISTEMA DE VOZ Y AVATAR DE QWEN3 =====

        // ===== CONFIGURACI√ìN DE HEYGEN =====
        // URL del avatar de HeyGen proporcionada por el usuario
        const HEYGEN_AVATAR_URL = 'https://app.heygen.com/videos/306d1c6f1b014036b467ff70ea38d965';

        // ===== VARIABLES GLOBALES PARA VOICE & AVATAR LAB =====
        let recognition = null;
        let isListening = false;
        let currentAudio = null;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let isBargeInActive = false;

        // ===== INICIALIZAR EL SISTEMA DE VOZ =====
        function initSandraVoiceSystem() {
            console.log('üéôÔ∏è Inicializando sistema de voz de Sandra...');

            // Inicializar Web Audio API para visualizaci√≥n de volumen
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;

            // Cargar el avatar de HeyGen
            loadHeyGenAvatar();

            // Eventos de los botones
            document.getElementById('voice-toggle-btn').addEventListener('click', toggleVoiceRecognition);
            document.getElementById('toggle-panel-btn').addEventListener('click', togglePanelSize);

            updateStatus('‚úÖ Sistema de voz listo. Haz clic en el micr√≥fono para empezar.');
        }

        // ===== CARGAR AVATAR HEYGEN =====
        function loadHeyGenAvatar() {
            const iframe = document.getElementById('heygen-iframe');
            const placeholder = document.getElementById('avatar-placeholder');

            if (HEYGEN_AVATAR_URL && HEYGEN_AVATAR_URL !== 'https://app.heygen.com/embed/your-avatar-id') {
                iframe.src = HEYGEN_AVATAR_URL;
                iframe.style.display = 'block';
                placeholder.style.display = 'none';
                console.log('ü§ñ Avatar de HeyGen cargado.');
            } else {
                placeholder.innerHTML = '‚ö†Ô∏è Configura HEYGEN_AVATAR_URL';
                console.warn('‚ö†Ô∏è URL de HeyGen no configurada.');
            }
        }

        // ===== ACTIVAR/DESACTIVAR RECONOCIMIENTO DE VOZ =====
        function toggleVoiceRecognition() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        // ===== INICIAR ESCUCHA =====
        async function startListening() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.lang = 'es-ES';

                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('voice-toggle-btn').innerHTML = 'üî¥';
                    document.getElementById('voice-toggle-btn').classList.add('pulse-animation');
                    document.getElementById('voice-toggle-btn').style.background = 'linear-gradient(135deg, #ef4444, #b91c1c)';
                    updateStatus('üé§ Escuchando... Habla naturalmente.');
                    startVolumeMonitoring();
                };

                recognition.onresult = async (event) => {
                    const transcript = event.results[event.results.length - 1][0].transcript.trim();
                    if (transcript.length > 2) {
                        recognition.stop();
                        await processUserMessage(transcript);
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Error de reconocimiento:', event.error);
                    updateStatus(`‚ùå Error: ${event.error}`);
                    resetVoiceButton();
                };

                recognition.onend = () => {
                    if (isListening) {
                        resetVoiceButton();
                    }
                };

                try {
                    await audioContext.resume(); // Necesario en algunos navegadores
                    recognition.start();
                } catch (error) {
                    console.error('Error al iniciar reconocimiento:', error);
                    updateStatus('‚ùå Error al acceder al micr√≥fono.');
                    resetVoiceButton();
                }
            } else {
                alert('Tu navegador no soporta reconocimiento de voz. Usa Chrome o Edge.');
                updateStatus('‚ùå Reconocimiento de voz no soportado.');
            }
        }

        // ===== DETENER ESCUCHA =====
        function stopListening() {
            if (recognition) recognition.stop();
            resetVoiceButton();
            stopVolumeMonitoring();
        }

        // ===== PROCESAR MENSAJE DEL USUARIO =====
        async function processUserMessage(message) {
            updateStatus('üß† Procesando tu mensaje...');
            console.log('Usuario dice:', message);

            // CONECTAR CON EL SISTEMA EXISTENTE DE SANDRA
            const aiResponse = await getSandraResponse(message);

            // Generar audio con ElevenLabs usando el sistema existente
            await generateAndPlayAudio(aiResponse);
        }

        // ===== GENERAR Y REPRODUCIR AUDIO CON ELEVENLABS =====
        async function generateAndPlayAudio(text) {
            updateStatus('üîä Generando audio con ElevenLabs...');

            try {
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${SANDRA_CONFIG.ELEVENLABS_VOICE_ID}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'xi-api-key': SANDRA_CONFIG.ELEVENLABS_API_KEY
                    },
                    body: JSON.stringify({
                        text: text,
                        voice_settings: {
                            stability: SANDRA_CONFIG.ELEVENLABS_STABILITY || 0.71,
                            similarity_boost: SANDRA_CONFIG.ELEVENLABS_SIMILARITY || 0.85
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error de ElevenLabs: ${response.status}`);
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                currentAudio = new Audio(audioUrl);

                // EVENTO: Cuando empieza a reproducirse
                currentAudio.onplay = () => {
                    updateStatus('üó£Ô∏è Sandra est√° hablando...');
                    document.getElementById('voice-toggle-btn').style.background = 'linear-gradient(135deg, #ec4899, #be185d)';
                    startVolumeMonitoring();
                };

                // EVENTO: Cuando termina de reproducirse
                currentAudio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    updateStatus('‚úÖ Listo para tu siguiente pregunta.');
                    resetVoiceButton();
                    stopVolumeMonitoring();
                };

                // ===== SISTEMA BARGE-IN =====
                // Si el usuario hace clic en el micr√≥fono mientras Sandra habla, la interrumpimos
                document.getElementById('voice-toggle-btn').onclick = () => {
                    if (currentAudio && !currentAudio.paused) {
                        // ¬°BARGE-IN ACTIVADO!
                        currentAudio.pause();
                        currentAudio.currentTime = 0;
                        isBargeInActive = true;
                        showBargeInIndicator();
                        console.log('üö® BARGE-IN: Audio de Sandra interrumpido por el usuario.');
                        startListening(); // Empezamos a escuchar al usuario inmediatamente
                    } else {
                        toggleVoiceRecognition();
                    }
                };

                // Reproducir el audio
                await currentAudio.play();

            } catch (error) {
                console.error('Error con ElevenLabs:', error);
                updateStatus('‚ùå Error generando audio. Usando voz del navegador.');
                // Fallback: usar SpeechSynthesis
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                speechSynthesis.speak(utterance);
                resetVoiceButton();
            }
        }

        // ===== MONITOREO DE VOLUMEN (VISUALIZADOR) =====
        async function startVolumeMonitoring() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);

                const volumeBar = document.getElementById('voice-volume-bar');
                function updateVolume() {
                    if (!isListening && !currentAudio) return;

                    const dataArray = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    const volume = Math.min(100, Math.max(0, (average / 255) * 100));
                    volumeBar.style.width = `${volume}%`;

                    requestAnimationFrame(updateVolume);
                }
                updateVolume();
            } catch (error) {
                console.error('Error al acceder al micr√≥fono para visualizaci√≥n:', error);
            }
        }

        function stopVolumeMonitoring() {
            if (microphone) {
                microphone.disconnect();
                microphone = null;
            }
        }

        // ===== FUNCIONES AUXILIARES =====
        function resetVoiceButton() {
            isListening = false;
            document.getElementById('voice-toggle-btn').innerHTML = 'üé§';
            document.getElementById('voice-toggle-btn').classList.remove('pulse-animation');
            document.getElementById('voice-toggle-btn').style.background = 'linear-gradient(135deg, #0ea5e9, #0284c7)';
        }

        function updateStatus(message) {
            document.getElementById('voice-status').textContent = message;
        }

        function showBargeInIndicator() {
            const indicator = document.getElementById('barge-in-indicator');
            indicator.classList.remove('hidden');
            setTimeout(() => {
                indicator.classList.add('hidden');
                isBargeInActive = false;
            }, 2000);
        }

        function togglePanelSize() {
            const panel = document.getElementById('sandra-voice-control-panel');
            const isMinimized = panel.classList.contains('scale-75');
            if (isMinimized) {
                panel.classList.remove('scale-75');
                panel.classList.add('scale-100');
                document.getElementById('toggle-panel-btn').textContent = 'Minimizar';
            } else {
                panel.classList.remove('scale-100');
                panel.classList.add('scale-75');
                document.getElementById('toggle-panel-btn').textContent = 'Expandir';
            }
        }

        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', async function() {
            // Inicializar UI
            initSonomaBackground();
            safeLoadMemory();
            loadLibraryToUI();
            updateProgressBars();

            // INICIALIZAR SISTEMA DE VOZ Y AVATAR DE QWEN3
            console.log('üîß Inicializando Voice & Avatar Lab de QWEN3...');
            initSandraVoiceSystem();

            // INICIALIZAR PERMISOS Y SISTEMA BARGE-IN ORIGINAL
            console.log('üîß Inicializando permisos de micr√≥fono...');
            const micPermissionGranted = await initializeMicrophonePermissions();

            if (micPermissionGranted) {
                // Inicializar sistema barge-in solo si hay permisos
                setTimeout(() => {
                    initializeBargeInSystem();
                    // Inicializar estado del bot√≥n barge-in
                    document.getElementById('barge-in-btn').style.background = 'rgba(34, 197, 94, 0.3)';
                }, 1000);

                console.log('‚úÖ Sistema de micr√≥fono y barge-in inicializado');
            } else {
                console.warn('‚ö†Ô∏è Permisos de micr√≥fono no concedidos - funcionalidades limitadas');
                document.getElementById('voice-status').textContent = '‚ö†Ô∏è Sin permisos de micr√≥fono';
                // Deshabilitar barge-in si no hay permisos
                document.getElementById('barge-in-btn').style.background = 'rgba(107, 114, 128, 0.3)';
                document.getElementById('barge-in-btn').innerHTML = 'üö´';
                document.getElementById('barge-in-btn').title = 'Sin permisos de micr√≥fono';
                bargeInEnabled = false;
            }

            // Sandra se presenta autom√°ticamente
            setTimeout(() => {
                const hora = new Date().getHours();
                const saludo = hora < 12 ? 'Buenos d√≠as' : hora < 18 ? 'Buenas tardes' : 'Buenas noches';
                const welcomeMessage = `${saludo}! üëã Soy Sandra IA Ultimate, tu asistente personal de desarrollo.

üöÄ **Sistema Iniciado con √âxito:**
‚úÖ APIs conectadas y verificadas
‚úÖ Voice synthesis ElevenLabs activo
‚úÖ Auto-training system ready
‚úÖ Memory system cargado
‚úÖ Premium prompts library disponible
${micPermissionGranted ? '‚úÖ Sistema Barge-In activado' : '‚ö†Ô∏è Barge-In limitado sin permisos'}

üí´ **¬øC√≥mo puedo ayudarte hoy?**
‚Ä¢ Desarrollo y c√≥digo expert-level
‚Ä¢ Arquitectura y design systems
‚Ä¢ Training personalizado con prompts
‚Ä¢ S√≠ntesis de voz para explicaciones
‚Ä¢ Chat en tiempo real con memoria

${micPermissionGranted ? 'üî• **Nuevo:** ¬°Puedes interrumpirme mientras hablo! Sistema Barge-In activo.' : ''}

¬°Escribe algo o usa el micr√≥fono para empezar! üé§`;

                addMessageToChat(false, welcomeMessage);
                generateAudio("Hola! Soy Sandra IA Ultimate. Todas mis APIs est√°n conectadas y listas. ¬øEn qu√© puedo ayudarte hoy?");
            }, 1500);

            // Event listeners
            document.getElementById('auto-train-btn').addEventListener('click', startAutoTraining);
            document.getElementById('send-btn').addEventListener('click', handleSendMessage);
            document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
            document.getElementById('barge-in-btn').addEventListener('click', toggleBargeIn);

            document.getElementById('user-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleSendMessage();
                }
            });

            document.getElementById('mic-btn').addEventListener('click', function() {
                if (isListening) {
                    recognition.stop();
                } else {
                    startVoiceRecognition();
                }
            });

            document.getElementById('prompt-file-input').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files);
                }
            });

            // Mensaje de bienvenida con voz
            setTimeout(() => {
                const welcomeMessage = 'Sandra Dev Lab Ultimate inicializado con APIs reales. Todas las funciones est√°n activas.';
                addMessageToChat(false, welcomeMessage);
                generateAudio(welcomeMessage);
            }, 1000);

            console.log('üöÄ Sandra Dev Lab Ultimate inicializado con configuraci√≥n BESTIAL');
            console.log('üåü ¬°Sandra Voice & Avatar Lab de QWEN3 completamente cargado!');
        });
    </script>
</body>
</html>