// netlify/functions/chat.js
const fetch = (...args) => import('node-fetch').then(({default: f}) => f(...args));

const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const ELEVEN_KEY   = process.env.ELEVENLABS_API_KEY;
const ELEVEN_VOICE = process.env.ELEVENLABS_VOICE_ID || "Rachel";
const HEYGEN_API_KEY = process.env.HEYGEN_API_KEY;
const HEYGEN_AVATAR_ID = process.env.HEYGEN_AVATAR_ID;
const UPSTREAM_URL = process.env.UPSTREAM_API_URL;       // ej: https://api.guestsvalencia.es/sandra/v7
const UPSTREAM_KEY = process.env.UPSTREAM_API_KEY || "";
const ALLOW_ORIGIN = process.env.ALLOW_ORIGIN || "*";

// Utilidad para responder binario (MP3) en Netlify
function mp3Response(buffer) {
  return {
    statusCode: 200,
    isBase64Encoded: true,
    headers: {
      "Content-Type": "audio/mpeg",
      "Access-Control-Allow-Origin": ALLOW_ORIGIN,
      "Cache-Control": "no-store"
    },
    body: Buffer.from(buffer).toString("base64"),
  };
}

exports.handler = async (event) => {
  if (event.httpMethod !== "POST") {
    return { statusCode: 405, body: "Method Not Allowed" };
  }

  try {
    const { text = "" } = JSON.parse(event.body || "{}");
    const prompt = text.trim() || "Hola, ¿en qué puedo ayudarte?";

    // 1) OpenAI ChatGPT respuesta
    let reply = "";
    if (OPENAI_API_KEY) {
      try {
        const openaiRes = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${OPENAI_API_KEY}`
          },
          body: JSON.stringify({
            model: "gpt-4",
            messages: [
              {
                role: "system",
                content: "Eres Sandra, una asistente virtual inteligente de ClayTom Systems especializada en desarrollo web, gestión hotelera y atención al cliente. Responde de manera profesional, concisa y útil en español."
              },
              {
                role: "user",
                content: prompt
              }
            ],
            max_tokens: 150,
            temperature: 0.7
          })
        });

        if (openaiRes.ok) {
          const openaiData = await openaiRes.json();
          reply = openaiData.choices?.[0]?.message?.content || "";
        }
      } catch (_) { /* fallback abajo */ }
    }

    // 2) Fallback UPSTREAM (opcional)
    if (!reply && UPSTREAM_URL) {
      try {
        const r = await fetch(`${UPSTREAM_URL}/chat`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(UPSTREAM_KEY ? { "Authorization": `Bearer ${UPSTREAM_KEY}` } : {})
          },
          body: JSON.stringify({ text: prompt })
        });
        if (r.ok) {
          const j = await r.json().catch(() => ({}));
          reply = j.reply || j.text || j.message || "";
        }
      } catch (_) { /* fallback abajo */ }
    }

    // 3) Fallback final
    if (!reply) reply = `He recibido tu mensaje: "${prompt}". ¿Qué necesitas?`;

    // 4) TTS ElevenLabs → MP3
    if (!ELEVEN_KEY) {
      // Si no hay clave, devolvemos MP3 "silencioso" cortito para no romper el flujo
      const silent = Buffer.alloc(0);
      return mp3Response(silent);
    }

    const ttsRes = await fetch(
      `https://api.elevenlabs.io/v1/text-to-speech/${ELEVEN_VOICE}/stream?optimize_streaming_latency=3`,
      {
        method: "POST",
        headers: {
          "xi-api-key": ELEVEN_KEY,
          "Accept": "audio/mpeg",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          text: reply,
          model_id: "eleven_turbo_v2",
          voice_settings: { stability: 0.5, similarity_boost: 0.7 }
        })
      }
    );

    if (!ttsRes.ok) {
      const errTxt = await ttsRes.text().catch(()=>String(ttsRes.status));
      return { statusCode: 502, body: `TTS error: ${errTxt}` };
    }

    const mp3Buffer = Buffer.from(await ttsRes.arrayBuffer());
    return mp3Response(mp3Buffer);

  } catch (e) {
    return { statusCode: 500, body: `chat error: ${e.message}` };
  }
};
